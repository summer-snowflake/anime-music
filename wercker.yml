box: ruby
services:
  - id: postgres

build:
  steps:
    - bundle-install

brakeman:
  steps:
    - bundle-install
    - script:
      name: Display Brakeman
      code: RAILS_ENV=test bundle exec brakeman
    - script:
      name: Report Brakeman
      code: RAILS_ENV=test bundle exec brakeman -o tmp/output.json
    - script:
      name: Security Check Result
      code: ruby -rjson -e "num = (JSON.parse File.read('tmp/output.json'))['scan_info']['security_warnings']; raise if num > 0"

test:
  steps:
    - script:
      name: Build npm
      code: |
        sudo apt-get update
        sudo apt-get -y install nodejs npm
        npm install -g n
        n latest
    - npm-install
    - npm-test
    - bundle-install
    - script:
      name: Check using eslint
      code: ./node_modules/eslint/bin/eslint.js app/assets/javascripts/
    - script:
      name: Check using Rubocop
      code: RAILS_ENV=test bundle exec rubocop app spec lib
    - rails-database-yml
    - script:
      name: Set up DB
      code: RAILS_ENV=test bundle exec rake db:schema:load
    - script:
      name: Enable virtual display(thanks to zephiransas blog!
      code: |
        export DISPLAY=:99.0
        start-stop-daemon --start --quiet --pidfile /tmp/xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset
        sleep 3
    - desmondmorris/selenium-install@0.0.2
    - script:
      name: Test using Rspec
      code: RAILS_ENV=test bundle exec rspec
  after-steps:
    - wantedly/pretty-slack-notify:
      webhook_url: "$SLACK_WEBHOOK_URL"
      channel: notify

deploy:
  steps:
    - heroku-deploy:
      install-toolbelt: true
      app-name: $APP_NAME
      key-name: HEROKU_SSH_KEY
  after-steps:
    - wantedly/pretty-slack-notify:
      webhook_url: "$SLACK_WEBHOOK_URL"
      channel: dev
